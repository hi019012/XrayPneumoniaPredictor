<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>機械学習</title>
    </head>
    <style>
        h1{text-align: center;}
        body{text-align: center;}
    </style>
    <body>
            <h1>X-ray | NORMAL OR PNEMONIA</h1>
        <div class="select">
            <input type="file" id="file" name="file" style="font-size:24px;"></input>
        </div>
            <br />
        <div class="selectedimg">
            <img id="aaa" width="200" height="200"/>
        </div>
            <br />
            <button id="predict" style="font-size:24px;">Predict</button><br/>
            <p>0: 正常 | 1: 肺炎</p>
            Predicted Digit: <label id="predicted-digit" style="color:darkred;font-size:48px;"></label><br/>
            Probability of pneumonia: <label id="prediction" style="font-size: 30;"></label> %
    </body>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <script>
        var URL_PREDICTION = '/predictions';
        //var DRAWING_LINE_WIDTH = 20;
        //var DRAWING_STROKE_STYLE = 'yellow';
        //var ctx = $('#canvas')[0].getContext('2d');

        /*
        function drawFromFile(e) {
            console.log('drawFromFile() called.');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            var image = new Image();
            image.onload = () => {
                ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, ctx.canvas.width, ctx.canvas.height);
            }
            image.src = URL.createObjectURL(e.target.files[0]);
        }
        */

        $('#file').on('change', function (e) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $("#aaa").attr('src', e.target.result);
                img = new Image();
                img.src = this.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        /*
        var prevX, prevY;
        var mousePressed = false;
        function drawByMouse(x, y, isDown) {
            if (isDown) {
                ctx.beginPath();
                ctx.strokeStyle = DRAWING_STROKE_STYLE;
                ctx.lineWidth = DRAWING_LINE_WIDTH;
                ctx.lineJoin = "round";
                ctx.moveTo(prevX, prevY);
                ctx.lineTo(x, y);
                ctx.closePath();
                ctx.stroke();
            }
            prevX = x;
            prevY = y;
        }
        */

        /*
        function clearCanvas() {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            $('#file')[0].value = null;
            $('#predicted-digit')[0].textContent = '';
            $('#response-body')[0].textContent = '';
        }
        */

        function postPredictionRequest() {
            console.log('postPredictionRequest() called.');

            /*
            // Retrieve the image data from canvas.
            dataURL = img.toDataURL('image/png');
            // Remove the unnecessary header which is something like 'data:image/png;base64,'.
            imageInBase64 = dataURL.replace(/^.*,/, '');
            */
            
            dataURL = img.src;
            imageInBase64 = dataURL.replace(/^.*,/, '');
            
            // Create a request body.
            //var requestBody = {};
            //requestBody['image'] = imageInBase64;
            
            var requestBody = {};
            requestBody['image'] = imageInBase64;
            console.log(requestBody);
            
            // Set a callback function to handle the response.
            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = () => { 
                if (xhr.readyState == 4){
                    if(xhr.status == 200){
                        var responseInText = xhr.responseText;
                        console.log(responseInText);
                        var responseInJson = JSON.parse(responseInText);
                        $('#predicted-digit')[0].textContent = responseInJson['predictedDigit'];
                        //$('#response-body')[0].textContent = responseInText;
                        $('#prediction')[0].textContent = responseInJson['prediction'];
                    } else {
                        alert('Oops! Something went wrong. \nStatus: '
                                + xhr.status + '\n' + xhr.responseText);
                    }
                }
            }

            // POST /prediction.
            xhr.open('POST', URL_PREDICTION);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(requestBody));
        }


        /*
        $('#clear').click(() => {
            clearCanvas();
        });
        */

        /*
        $('#file').change((e) => {
            drawFromFile(e);
        });
        */

        $('#predict').click(() => {
            postPredictionRequest();
        });

        /*
        $('#canvas').mousedown(function(e) {
            mousePressed = true;
            drawByMouse(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, false);
        });

        $('#canvas').mousemove(function(e) {
            if (mousePressed) {
                drawByMouse(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
            }
        });

        $('#canvas').mouseup(function(e) {
            mousePressed = false;
        });

        $('#canvas').mouseleave(function(e) {
            mousePressed = false;
        });
        */
    </script>
</html>